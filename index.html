<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ICAO Wordle</title>
  <style>
    body {
      margin: 0;
      padding: 1rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #121213;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
      text-align: center;
    }

    #subtitle {
      font-size: 0.9rem;
      color: #aaaaaa;
      margin-bottom: 1rem;
      text-align: center;
    }

    #game {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      width: 100%;
      max-width: 250px;
      align-items: center;
    }

    #grid {
      display: grid;
      grid-template-rows: repeat(6, 1fr);
      gap: 0.35rem;
      width: 100%;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.35rem;
    }

    .tile {
      border: 2px solid #3a3a3c;
      border-radius: 4px;
      width: 100%;
      padding-top: 100%; /* kwadrat */
      position: relative;
      text-transform: uppercase;
      font-weight: bold;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    .tile span {
      position: absolute;
    }

    .tile.correct {
      background-color: #538d4e;
      border-color: #538d4e;
      color: #f5f5f5;
    }

    .tile.present {
      background-color: #b59f3b;
      border-color: #b59f3b;
      color: #f5f5f5;
    }

    .tile.absent {
      background-color: #3a3a3c;
      border-color: #3a3a3c;
      color: #f5f5f5;
    }

    #controls {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 100%;
      max-width: 400px;
    }

    #inputRow {
      display: flex;
      gap: 0.5rem;
    }

    #guessInput {
      flex: 1;
      padding: 0.5rem 0.75rem;
      font-size: 1.1rem;
      text-transform: uppercase;
      border-radius: 4px;
      border: 1px solid #3a3a3c;
      background-color: #1a1a1b;
      color: #f5f5f5;
      box-sizing: border-box;
    }

    #guessButton, #newGameButton {
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
      background-color: #538d4e;
      color: #f5f5f5;
      font-weight: 600;
    }

    #newGameButton {
      background-color: #3b82f6;
      width: 100%;
    }

    #guessButton:disabled,
    #newGameButton:disabled {
      opacity: 0.6;
    }

    #message {
      min-height: 1.2rem;
      font-size: 0.95rem;
      text-align: center;
    }

    #codesStatus {
      font-size: 0.8rem;
      color: #bbbbbb;
      text-align: center;
    }

    .highlight {
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>ICAO Wordle</h1>
  <div id="subtitle">Odgadnij 4-literowy kod lotniska ICAO</div>

  <div id="game">
    <div id="grid"></div>

    <div id="controls">
      <div id="inputRow">
        <input
          id="guessInput"
          type="text"
          maxlength="4"
          autocomplete="off"
          autocapitalize="characters"
          placeholder="Wpisz kod (np. EPWA)"
        />
        <button id="guessButton">OK</button>
      </div>
      <button id="newGameButton">Nowa gra</button>
      <div id="message"></div>
      <div id="codesStatus"></div>
    </div>
  </div>

  <script>
    const MAX_ATTEMPTS = 7;
    const WORD_LENGTH = 4;
    const CODES_URL = "https://raw.githubusercontent.com/datasets/airport-codes/master/data/airport-codes.csv";

    let allCodes = [];
    let targetCode = "";
    let currentAttempt = 0;
    let gameOver = false;

    const gridEl = document.getElementById("grid");
    const guessInput = document.getElementById("guessInput");
    const guessButton = document.getElementById("guessButton");
    const newGameButton = document.getElementById("newGameButton");
    const messageEl = document.getElementById("message");
    const codesStatusEl = document.getElementById("codesStatus");

    // Tworzenie pustej siatki 6 x 4
    function createEmptyGrid() {
      gridEl.innerHTML = "";
      for (let row = 0; row < MAX_ATTEMPTS; row++) {
        const rowEl = document.createElement("div");
        rowEl.className = "row";
        for (let col = 0; col < WORD_LENGTH; col++) {
          const tile = document.createElement("div");
          tile.className = "tile";
          const span = document.createElement("span");
          tile.appendChild(span);
          rowEl.appendChild(tile);
        }
        gridEl.appendChild(rowEl);
      }
    }

    function setMessage(text, isError = false) {
      messageEl.textContent = text;
      messageEl.style.color = isError ? "#f97373" : "#f5f5f5";
    }

    function setCodesStatus(text) {
      codesStatusEl.textContent = text;
    }

    // Prosty parser CSV jednej linii, ogarnia cudzysłowy i przecinki w nazwach
    function parseCsvLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const c = line[i];

            if (c === '"') {
                // przełączamy stan "w cudzysłowie"
                inQuotes = !inQuotes;
            } else if (c === "," && !inQuotes) {
                // koniec pola
                result.push(current);
                current = "";
            } else {
                current += c;
            }
        }
        result.push(current);
        return result;
    }


    // Wczytanie pliku z kodami ICAO
    async function loadCodes() {
        try {
            const res = await fetch(CODES_URL);
            if (!res.ok) {
                throw new Error("HTTP " + res.status);
            }
            const txt = await res.text();
            const lines = txt.split(/\r?\n/).filter(l => l.trim().length > 0);

            if (lines.length < 2) {
                throw new Error("Plik CSV jest pusty lub za krótki");
            }

            // Nagłówek – ustalamy indeksy kolumn po nazwie
            const header = parseCsvLine(lines[0]);
            const identIdx = header.indexOf("ident");
            const typeIdx = header.indexOf("type");
            const iataIdx = header.indexOf("iata_code");

            if (identIdx === -1 || typeIdx === -1 || iataIdx === -1) {
                throw new Error("Brakuje kolumn ident/type/iata_code w CSV");
            }

            const allowedTypes = new Set(["large_airport"]);

            allCodes = [];

            for (let i = 1; i < lines.length; i++) {
                const row = parseCsvLine(lines[i]);
                if (row.length <= Math.max(identIdx, typeIdx, iataIdx)) continue;

                const ident = (row[identIdx] || "").replace(/"/g, "").trim().toUpperCase();
                const type = (row[typeIdx] || "").replace(/"/g, "").trim();
                const iata = (row[iataIdx] || "").replace(/"/g, "").trim().toUpperCase();

                // Tylko 4-literowe kody ICAO
                if (!/^[A-Z]{4}$/.test(ident)) continue;

                // Tylko lotniska komercyjne: duże/średnie + mają kod IATA
                if (!allowedTypes.has(type)) continue;
                if (!iata) continue;

                allCodes.push(ident);
            }

            if (allCodes.length === 0) {
                throw new Error("Brak kodów po filtrze komercyjnych lotnisk");
            }

            setCodesStatus(
                `Załadowano kody komercyjnych lotnisk ICAO (${allCodes.length} pozycji).`
            );
        } catch (e) {
            console.error("Błąd wczytywania kodów:", e);
            setCodesStatus(
                "Nie udało się pobrać danych z GitHuba – używam małej, wbudowanej listy."
            );
            // Fallback offline / bez neta / błąd
            allCodes = ["EPWA", "EPKK", "EPGD", "EPKT", "EPMO", "EPPO"];
        }
    }


    function pickRandomTarget() {
      const idx = Math.floor(Math.random() * allCodes.length);
      targetCode = allCodes[idx];
      console.log("Wylosowany kod (debug):", targetCode);
    }

    function resetGame() {
      gameOver = false;
      currentAttempt = 0;
      createEmptyGrid();
      pickRandomTarget();
      setMessage("");
      guessInput.value = "";
      guessInput.disabled = false;
      guessButton.disabled = false;
      guessInput.focus();
    }

    function validateGuess(rawGuess) {
      const guess = rawGuess.trim().toUpperCase();
      if (guess.length !== WORD_LENGTH) {
        setMessage("Kod musi mieć dokładnie 4 litery.", true);
        return null;
      }
      if (!/^[A-Z]+$/.test(guess)) {
        setMessage("Używaj tylko liter A–Z.", true);
        return null;
      }
      // (opcjonalnie) sprawdzenie czy kod w ogóle istnieje na liście
      if (!allCodes.includes(guess)) {
        setMessage("Taki kod nie znajduje się na liście.", true);
        return null;
      }
      return guess;
    }

    // Zwraca tablicę statusów: "correct" | "present" | "absent"
    function checkGuess(guess, target) {
      const result = new Array(WORD_LENGTH).fill("absent");
      const targetArr = target.split("");
      const guessArr = guess.split("");

      // Najpierw oznaczamy trafienia na właściwej pozycji
      const remainingLetterCounts = {};

      for (let i = 0; i < WORD_LENGTH; i++) {
        if (guessArr[i] === targetArr[i]) {
          result[i] = "correct";
        } else {
          const letter = targetArr[i];
          remainingLetterCounts[letter] = (remainingLetterCounts[letter] || 0) + 1;
        }
      }

      // Następnie oznaczamy litery obecne, lecz w innym miejscu
      for (let i = 0; i < WORD_LENGTH; i++) {
        if (result[i] === "correct") continue;
        const letter = guessArr[i];
        if (remainingLetterCounts[letter] > 0) {
          result[i] = "present";
          remainingLetterCounts[letter]--;
        }
      }

      return result;
    }

    function renderGuess(guess, statuses) {
      const rowEl = gridEl.children[currentAttempt];
      const tiles = rowEl.children;
      for (let i = 0; i < WORD_LENGTH; i++) {
        const tile = tiles[i];
        const span = tile.querySelector("span");
        span.textContent = guess[i];
        tile.classList.add(statuses[i]);
      }
    }

    function handleGuess() {
      if (gameOver) return;

      const rawGuess = guessInput.value;
      const guess = validateGuess(rawGuess);
      if (!guess) return;

      const statuses = checkGuess(guess, targetCode);
      renderGuess(guess, statuses);

      if (guess === targetCode) {
        setMessage(`Brawo! Poprawny kod to ${targetCode}.`);
        gameOver = true;
        guessInput.disabled = true;
        guessButton.disabled = true;
        return;
      }

      currentAttempt++;

      if (currentAttempt >= MAX_ATTEMPTS) {
        setMessage(`Koniec gry! Szukany kod to ${targetCode}.`);
        gameOver = true;
        guessInput.disabled = true;
        guessButton.disabled = true;
      } else {
        setMessage(`Próba ${currentAttempt + 1} z ${MAX_ATTEMPTS}.`);
      }

      guessInput.value = "";
      guessInput.focus();
    }

    // Obsługa przycisków i Entera
    guessButton.addEventListener("click", handleGuess);
    newGameButton.addEventListener("click", resetGame);
    guessInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        handleGuess();
      }
    });

    // Inicjalizacja
    (async function init() {
      createEmptyGrid();
      setCodesStatus("Wczytywanie kodów ICAO z pliku...");
      await loadCodes();
      resetGame();
    })();
  </script>
</body>
</html>

